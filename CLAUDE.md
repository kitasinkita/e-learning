# 🤖 Claude Code開発ガイド

## 📋 プロジェクト概要

Claude Code eラーニングシステムの開発・保守において、Claude Codeを効果的に活用するためのガイドです。

### プロジェクト構成
```
elearning-system/
├── server.js              # Express.js メインサーバー
├── setup.js               # SQLite DB初期化スクリプト
├── public/                # フロントエンド（HTML/CSS/JS）
├── slides/                # レッスンスライド（HTML）
├── elearning.db          # SQLiteデータベース
└── docs/                 # ドキュメント類
```

### 技術スタック
- **バックエンド**: Node.js + Express.js + SQLite3
- **認証**: JWT + bcrypt
- **フロントエンド**: Vanilla JavaScript + HTML/CSS
- **デプロイ**: GitHub Codespaces / Render

---

## 🚀 Claude Codeでの開発フロー

### 1. 環境セットアップ

```bash
# プロジェクトクローン
git clone https://github.com/kitasinkita/e-learning.git
cd e-learning

# 依存関係インストール
npm install

# データベース初期化
node setup.js

# 開発サーバー起動
npm start
```

### 2. 開発時の基本コマンド

```bash
# サーバー起動（開発用）
npm start

# データベースリセット
rm elearning.db && node setup.js

# 依存関係更新
npm update

# テスト実行
node simple-e2e-test.js
```

---

## 💡 Claude Codeプロンプト例

### 新機能開発

#### レッスンスライド作成
```
レッスン2「基本操作 & GitHub入門」のスライドを作成してください。

要件:
- レッスン1と同じデザイン・構造を維持
- 11-12スライド構成
- Claude Codeの効果的なプロンプト技法
- GitHub基本操作（clone, commit, push）
- VS Code + GitHub統合ワークフロー
- 実習課題2つ含む

ファイル: ../slides/lesson2_slides.html
```

#### API機能追加
```
学習時間の詳細統計APIを追加してください。

要件:
- エンドポイント: GET /api/admin/time-stats
- 管理者権限必須
- レスポンス: ユーザー別・レッスン別学習時間
- 日別・週別・月別の集計機能
- 既存のserver.jsに追加

参考: 既存のprogressテーブルのtime_spentカラムを活用
```

### バグ修正・改善

#### CORS問題修正
```
ログイン時の「サーバーとの通信に失敗」エラーを修正してください。

現象:
- GitHub Codespacesで不定期に発生
- ローカル環境では問題なし
- CORSエラーと思われる

調査・修正対象:
- server.jsのCORS設定
- フロントエンドのAPI呼び出し
- 環境別設定の分離

既存ファイル: server.js, public/login.html
```

#### レスポンシブ対応
```
管理者ダッシュボードのモバイル表示を改善してください。

問題:
- テーブルが横にはみ出る
- ボタンが小さくて押しにくい
- フォントサイズが不適切

対象ファイル: public/admin-dashboard.html
要件: 768px以下でのレイアウト最適化
```

### データベース操作

#### テーブル設計変更
```
notifications テーブルを新規追加してください。

要件:
- ユーザーへの通知機能
- 既存のusersテーブルと関連付け
- 未読・既読管理
- 通知タイプ（レッスン完了、実演レビュー等）

setup.jsに追加してマイグレーション対応も含めて
```

---

## 🔧 よく使用する修正パターン

### 1. 新しいレッスン追加

```
レッスン6「Python AI開発入門」を追加してください。

作業内容:
1. slides/lesson6_slides.html作成
2. student-dashboard.htmlのlessons配列に追加
3. server.jsのスライド数検出対応
4. setup.jsのサンプルデータ追加

要件:
- 既存レッスンと同じ構造
- 新しい実演課題2つ
- 15スライド程度
```

### 2. UI/UX改善

```
ダッシュボードのユーザビリティを改善してください。

改善点:
- 読み込み中のローディング表示
- エラーメッセージの分かりやすさ
- ボタンのホバー効果強化
- 進捗バーの視認性向上

対象: public/student-dashboard.html, public/admin-dashboard.html
```

### 3. セキュリティ強化

```
ログイン機能のセキュリティを強化してください。

実装内容:
- パスワード強度チェック
- ログイン試行回数制限
- セッションタイムアウト警告
- CSRF対策

対象ファイル: server.js, public/login.html
```

---

## 📊 開発時の注意点

### 1. データベース操作
- **必ずバックアップ**: `cp elearning.db backup.db`
- **マイグレーション**: 既存データ保持を考慮
- **テスト環境**: 本番データを直接触らない

### 2. フロントエンド開発
- **認証チェック**: 全ページで`checkAuth()`実行
- **エラーハンドリング**: ユーザーフレンドリーなメッセージ
- **レスポンシブ**: モバイル・タブレット対応

### 3. API設計
- **認証必須**: `authenticateToken`ミドルウェア使用
- **エラーレスポンス**: 統一されたフォーマット
- **ログ出力**: デバッグ用のconsole.log追加

---

## 🧪 テスト・デバッグ

### 開発用プロンプト

```
このコードをテストしてください。

テスト項目:
1. 正常系: 期待される動作確認
2. 異常系: エラーハンドリング確認
3. セキュリティ: 認証・認可の確認
4. パフォーマンス: 大量データでの動作

テストファイル: simple-e2e-test.js を拡張
```

### デバッグ支援

```
以下のエラーの原因を調査して修正してください。

エラーメッセージ: [エラー内容をペースト]
発生タイミング: [操作手順]
環境: GitHub Codespaces / ローカル
ブラウザ: Chrome/Safari/Firefox

関連ファイルを確認して根本原因を特定してください。
```

---

## 📈 パフォーマンス最適化

### Claude Codeでの最適化依頼

```
システムのパフォーマンスを改善してください。

調査・改善対象:
1. SQLクエリの最適化
2. フロントエンドのJavaScript処理
3. 画像・CSS最適化
4. キャッシュ戦略

現在の問題:
- ダッシュボード読み込みが遅い
- 大量ユーザー時のレスポンス低下

目標: 3秒以内での画面表示
```

---

## 🔒 セキュリティチェックリスト

### セキュリティ監査プロンプト

```
セキュリティ監査を実施してください。

チェック項目:
□ SQLインジェクション対策
□ XSS（クロスサイトスクリプティング）対策
□ CSRF対策
□ 認証・認可の実装
□ パスワードハッシュ化
□ セッション管理
□ 入力値検証
□ エラー情報の漏洩防止

問題があれば修正案も提示してください。
```

---

## 📚 ドキュメント更新

### ドキュメント生成プロンプト

```
新機能のドキュメントを更新してください。

更新対象:
- TECHNICAL_SPEC.md: API仕様追加
- SETUP_GUIDE.md: 新しい設定手順
- TROUBLESHOOTING.md: 新しい問題と解決策

変更内容: [機能変更の詳細]
```

---

## 🚀 デプロイ・運用

### デプロイ支援

```
本番環境へのデプロイを準備してください。

作業内容:
1. 環境変数設定ファイル作成
2. 本番用設定の分離
3. デプロイスクリプト作成
4. ヘルスチェック機能追加

デプロイ先: Render / Railway / Vercel
```

### 運用監視

```
システム監視機能を追加してください。

実装内容:
- ログ機能強化
- エラー通知機能
- パフォーマンス計測
- ユーザー行動分析

目的: 安定運用とユーザー体験向上
```

---

## 🤝 チーム開発

### コードレビュー依頼

```
以下のコードをレビューしてください。

レビュー観点:
1. コード品質・可読性
2. セキュリティ
3. パフォーマンス
4. 既存コードとの一貫性
5. テストカバレッジ

ファイル: [変更したファイルを指定]
```

### リファクタリング

```
既存コードをリファクタリングしてください。

目的:
- 保守性向上
- 重複コード削減
- モジュール化
- TypeScript化検討

対象: server.js（500行超のため分割）
```

---

## 📝 コード生成テンプレート

### 新API追加テンプレート

```
以下の仕様でAPIを追加してください。

エンドポイント: [HTTPメソッド] /api/[パス]
認証: 必要/不要
パラメータ: [リクエスト形式]
レスポンス: [レスポンス形式]
処理内容: [具体的な処理]

既存のserver.jsに追加し、エラーハンドリングも含めてください。
```

### 新画面追加テンプレート

```
以下の仕様で新しい画面を作成してください。

画面名: [画面名]
URL: [パス]
機能: [画面の機能説明]
レイアウト: 既存のadmin-dashboard.htmlと同じデザイン
認証: 必要
API連携: [使用するAPI]

HTMLファイル作成とserver.jsルート追加をお願いします。
```

---

## 🔄 定期メンテナンス

### 月次メンテナンス

```
月次メンテナンスを実施してください。

作業内容:
1. 依存関係の更新（セキュリティパッチ含む）
2. ログファイルのローテーション
3. データベースの最適化
4. 不要ファイルの削除
5. バックアップの確認

npm audit も実行してセキュリティチェックしてください。
```

---

## 🚨 開発履歴・トラブルシューティング記録

### 2025-08-13 進捗表示バグ修正作業

#### 発見された問題
1. **進捗表示110%バグ**: 全ユーザーで「01 Claude Code入門」が110%表示
2. **ユーザー別進捗未反映**: 伊藤、柳沢、渡辺が全員同じ進捗値
3. **スライドファイル不在**: `/slides/`ディレクトリが空でスライド閲覧不可

#### 根本原因分析
- **API不整合**: `/api/lesson/1/slide-count`が404エラー返却
- **パス設定ミス**: server.js:113行目で`../slides`を指定（正しくは`./slides`）
- **デフォルト値問題**: フロントエンドが`totalSlides=10`、実際は15スライド
- **サンプルデータ**: 全ユーザーで`last_slide=11`の同一進捗データ

#### 実施した修正
1. **server.js修正**:
   ```javascript
   // 修正前: path.join(__dirname, '../slides', ...)
   // 修正後: path.join(__dirname, 'slides', ...)
   
   // エラー時のデフォルト値追加
   const defaultSlideCounts = { 1: 15, 2: 12, 3: 14, 4: 13, 5: 16 };
   ```

2. **データベース調整**:
   ```sql
   -- ユーザー別の差分進捗データ作成
   UPDATE progress SET last_slide = CASE 
     WHEN user_id = 2 THEN 8   -- EMP001: 53%
     WHEN user_id = 3 THEN 12  -- EMP002: 80%  
     WHEN user_id = 4 THEN 5   -- EMP003: 33%
   END WHERE lesson_id = 1;
   ```

3. **スライドファイル追加**: `/slides/`ディレクトリにlesson1-5_slides.html配置

#### 最終状態（リセット実行）
- **ユーザーアカウント**: 保持（EMP001/EMP002/EMP003 + ADMIN001）
- **学習履歴**: 完全リセット（progress, demonstrations = 0件）
- **動作状況**: 0からの挙動テスト可能

#### 技術メモ
- スライド数カウント: `grep -c 'slide-container' filename.html`
- サーバー再起動時は`lsof -ti:3000 | xargs kill`でポート解放
- API応答例: `{"lessonId":1,"totalSlides":15}`

#### 今後の注意点
1. スライドファイル追加時はサーバー再起動必須
2. 進捗データ変更時はブラウザ強制リロード推奨
3. E2Eテストは Playwright MCP 推奨

---

このCLAUDE.mdを参考に、Claude Codeでの開発を効率的に進めてください。具体的な状況に応じてプロンプトをカスタマイズしてご利用ください。
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartLearn Pro - 管理者ダッシュボード</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Apple Design System準拠 */
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #F9FAFB; /* bg-gray-50 */
            color: #111827; /* text-gray-900 */
            line-height: 1.625; /* leading-relaxed */
        }

        .header {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: #FFFFFF;
            padding: 16px 0; /* py-4 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); /* shadow-md */
        }

        .header-content {
            max-width: 56rem; /* max-w-4xl */
            width: 100%; /* w-full */
            margin: 0 auto; /* mx-auto */
            padding: 0 16px; /* px-4 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            line-height: 1.25; /* leading-tight */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px; /* gap-4 */
        }

        .logout-btn {
            background: #FFFFFF;
            color: #1D4ED8; /* text-blue-700 */
            border: 2px solid #1D4ED8;
            padding: 8px 16px; /* py-2 px-4 */
            border-radius: 8px; /* rounded-lg */
            cursor: pointer;
            font-weight: 600; /* font-semibold */
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 0.875rem; /* text-sm */
        }

        .logout-btn:hover {
            background: #EFF6FF; /* bg-blue-50 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .main-content {
            max-width: 56rem; /* max-w-4xl */
            width: 100%; /* w-full */
            margin: 32px auto; /* my-8 */
            padding: 0 16px; /* px-4 */
        }

        .tabs {
            background: #FFFFFF; /* bg-white */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 16px; /* rounded-2xl */
            margin-bottom: 24px; /* mb-6 */
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
        }

        .tab-buttons {
            display: flex;
            background: #F3F4F6; /* bg-gray-100 */
        }

        .tab-button {
            flex: 1;
            padding: 16px; /* p-4 */
            background: none;
            border: none;
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            color: #6B7280; /* text-gray-500 */
            font-size: 0.875rem; /* text-sm */
            min-height: 48px; /* タッチターゲット */
        }

        .tab-button.active {
            background: #FFFFFF; /* bg-white */
            color: #1D4ED8; /* text-blue-700 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .tab-button:hover:not(.active) {
            background: #E5E7EB; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }

        .tab-content {
            display: none;
            padding: 24px; /* p-6 */
        }

        .tab-content.active {
            display: block;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px; /* gap-4 */
            margin-bottom: 24px; /* mb-6 */
        }

        .stat-card {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: #FFFFFF;
            padding: 20px; /* p-5 */
            border-radius: 16px; /* rounded-2xl */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); /* shadow-md */
        }

        .stat-number {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 4px; /* mb-1 */
            line-height: 1.25; /* leading-tight */
        }

        .stat-label {
            font-size: 0.875rem; /* text-sm */
            opacity: 0.9;
            font-weight: 400; /* font-normal */
        }

        .data-table {
            background: #FFFFFF; /* bg-white */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 12px; /* rounded-xl */
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 0.875rem; /* text-sm */
        }
        
        /* 進捗テーブルの列幅調整 */
        .table th:nth-child(1), .table td:nth-child(1) { width: 15%; } /* ユーザー */
        .table th:nth-child(2), .table td:nth-child(2) { width: 12%; } /* 部署 */
        .table th:nth-child(3), .table td:nth-child(3) { width: 14%; } /* レッスン1 */
        .table th:nth-child(4), .table td:nth-child(4) { width: 14%; } /* レッスン2 */
        .table th:nth-child(5), .table td:nth-child(5) { width: 14%; } /* レッスン3 */
        .table th:nth-child(6), .table td:nth-child(6) { width: 14%; } /* レッスン4 */
        .table th:nth-child(7), .table td:nth-child(7) { width: 14%; } /* レッスン5 */
        .table th:nth-child(8), .table td:nth-child(8) { width: 8%; }  /* 全体進捗 */

        .table th {
            background: #1D4ED8; /* bg-blue-700 */
            color: #FFFFFF; /* text-white */
            padding: 12px 16px; /* py-3 px-4 */
            text-align: left;
            font-weight: 600; /* font-semibold */
            font-size: 0.875rem; /* text-sm */
        }

        .table td {
            padding: 12px 16px; /* py-3 px-4 */
            border-bottom: 1px solid #E5E7EB; /* border-gray-200 */
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap;
            color: #374151; /* text-gray-700 */
        }

        .table tr:hover {
            background: #F9FAFB; /* bg-gray-50 */
        }

        .status-badge {
            padding: 4px 8px; /* py-1 px-2 */
            border-radius: 12px; /* rounded-xl */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            white-space: nowrap;
            display: inline-block;
            line-height: 1.2;
        }

        .status-not-started {
            background: #F3F4F6; /* bg-gray-100 */
            color: #6B7280; /* text-gray-500 */
        }

        .status-in-progress {
            background: #FEF3C7; /* bg-amber-100 */
            color: #D97706; /* text-amber-600 */
        }

        .status-completed {
            background: #D1FAE5; /* bg-green-100 */
            color: #059669; /* text-green-600 */
        }

        .status-pending {
            background: #FEF3C7; /* bg-amber-100 */
            color: #D97706; /* text-amber-600 */
        }

        .status-submitted {
            background: #DBEAFE; /* bg-blue-100 */
            color: #1D4ED8; /* text-blue-700 */
        }

        .status-approved {
            background: #D1FAE5; /* bg-green-100 */
            color: #059669; /* text-green-600 */
        }

        .status-rejected {
            background: #FEE2E2; /* bg-red-100 */
            color: #DC2626; /* text-red-600 */
        }

        .action-buttons {
            display: flex;
            gap: 4px; /* gap-1 */
        }

        /* ボタンベーススタイル */
        .btn {
            padding: 8px 16px; /* py-2 px-4 */
            border: none;
            border-radius: 6px; /* rounded */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
            min-height: 36px; /* 小さいボタン用 */
        }

        .btn-primary {
            background: #3B82F6; /* bg-blue-500 */
            color: #FFFFFF; /* text-white */
        }

        .btn-primary:hover {
            background: #2563EB; /* bg-blue-600 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); /* shadow-md */
        }

        .btn-success {
            background: #059669; /* bg-green-600 */
            color: #FFFFFF; /* text-white */
        }

        .btn-success:hover {
            background: #047857; /* bg-green-700 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .btn-danger {
            background: #DC2626; /* bg-red-600 */
            color: #FFFFFF; /* text-white */
        }

        .btn-danger:hover {
            background: #B91C1C; /* bg-red-700 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .btn-info {
            background: #0EA5E9; /* bg-sky-500 */
            color: #FFFFFF; /* text-white */
        }

        .btn-info:hover {
            background: #0284C7; /* bg-sky-600 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }

        .add-user-form {
            background: #FFFFFF; /* bg-white */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 12px; /* rounded-xl */
            padding: 24px; /* p-6 */
            margin-bottom: 24px; /* mb-6 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px; /* gap-4 */
            margin-bottom: 16px; /* mb-4 */
        }

        .form-group {
            margin-bottom: 16px; /* mb-4 */
        }

        .form-group label {
            display: block;
            margin-bottom: 6px; /* mb-1.5 */
            font-weight: 600; /* font-semibold */
            color: #374151; /* text-gray-700 */
            font-size: 0.875rem; /* text-sm */
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px; /* py-3 px-4 */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 8px; /* rounded-lg */
            font-size: 0.875rem; /* text-sm */
            font-family: 'Noto Sans JP', sans-serif;
            transition: all 0.15s ease-in-out;
            background: #FFFFFF; /* bg-white */
            color: #111827; /* text-gray-900 */
            min-height: 44px; /* タッチターゲット */
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3B82F6; /* border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); /* ring-2 ring-blue-500 ring-opacity-20 */
        }

        .form-group input::placeholder, .form-group textarea::placeholder {
            color: #6B7280; /* placeholder-gray-500 */
        }

        .progress-chart {
            background: #FFFFFF; /* bg-white */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 12px; /* rounded-xl */
            padding: 24px; /* p-6 */
            margin-bottom: 24px; /* mb-6 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* shadow-sm */
        }

        .lesson-progress {
            margin-bottom: 20px;
        }

        .lesson-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: #E5E7EB; /* bg-gray-200 */
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px; /* mb-1 */
        }

        .progress-fill {
            background: linear-gradient(90deg, #3B82F6, #1D4ED8); /* プライマリカラー */
            height: 100%;
            transition: width 0.3s ease;
        }

        .demo-evidence {
            background: #F9FAFB; /* bg-gray-50 */
            padding: 12px; /* p-3 */
            border-radius: 8px; /* rounded-lg */
            margin: 8px 0; /* my-2 */
            border-left: 4px solid #3B82F6; /* border-l-4 border-blue-500 */
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFFFFF; /* bg-white */
            border: 1px solid #D1D5DB; /* border-gray-300 */
            border-radius: 24px; /* rounded-3xl モーダル */
            padding: 32px; /* p-8 */
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1); /* shadow-xl */
        }

        /* セクション見出し */
        .tab-content h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #111827; /* text-gray-900 */
            margin-bottom: 16px; /* mb-4 */
            line-height: 1.375; /* leading-snug */
        }

        .tab-content h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #111827; /* text-gray-900 */
            margin-bottom: 12px; /* mb-3 */
            line-height: 1.375; /* leading-snug */
        }

        /* フッター */
        .footer {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem; /* text-xs */
            color: #9CA3AF; /* text-gray-400 */
            text-align: center;
            z-index: 100;
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) { /* md未満 */
            .header-content {
                flex-direction: column;
                gap: 12px; /* gap-3 */
                text-align: center;
            }

            .main-content {
                padding: 0 16px; /* px-4 */
                margin: 24px auto; /* my-6 */
            }

            .tab-buttons {
                flex-direction: column;
            }

            .tab-button {
                border-radius: 0; /* 縦並び時は角丸をリセット */
            }

            .tab-button:first-child {
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
            }

            .tab-button:last-child {
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
            }

            .overview-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px; /* gap-3 */
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 0.75rem; /* text-xs */
            }
            
            .table td {
                padding: 8px 4px; /* py-2 px-1 */
            }
            
            .status-badge {
                font-size: 0.625rem; /* text-xsより小 */
                padding: 2px 6px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }

            .modal-content {
                padding: 20px; /* p-5 */
                width: 95%;
            }
        }

        @media (max-width: 640px) { /* sm未満 */
            .overview-stats {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem; /* text-2xl */
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>🔧 SmartLearn Pro 管理</h1>
            <div class="user-info">
                <span class="user-name" id="admin-name">管理者</span>
                <button class="logout-btn" onclick="logout()">ログアウト</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- タブメニュー -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('overview')">📊 概要</button>
                <button class="tab-button" onclick="showTab('users')">👥 ユーザー管理</button>
                <button class="tab-button" onclick="showTab('progress')">📚 学習進捗</button>
                <button class="tab-button" onclick="showTab('demonstrations')">🎯 実演管理</button>
            </div>

            <!-- 概要タブ -->
            <div id="overview" class="tab-content active">
                <h2>システム概要</h2>
                <div class="overview-stats" id="overview-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">登録ユーザー数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-learners">0</div>
                        <div class="stat-label">学習中ユーザー</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completed-courses">0</div>
                        <div class="stat-label">コース完了者</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-demos">0</div>
                        <div class="stat-label">承認待ち実演</div>
                    </div>
                </div>

                <div class="progress-chart">
                    <h3>全体学習進捗</h3>
                    <div id="overall-progress">
                        <!-- JavaScriptで生成 -->
                    </div>
                </div>
            </div>

            <!-- ユーザー管理タブ -->
            <div id="users" class="tab-content">
                <h2>ユーザー管理</h2>
                
                <div class="add-user-form">
                    <h3>新規ユーザー登録</h3>
                    <form id="add-user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>社員ID</label>
                                <input type="text" name="employee_id" required>
                            </div>
                            <div class="form-group">
                                <label>氏名</label>
                                <input type="text" name="name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>メールアドレス</label>
                                <input type="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label>部署</label>
                                <input type="text" name="department">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>初期パスワード</label>
                            <input type="password" name="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ユーザー登録</button>
                    </form>
                </div>

                <div class="data-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>社員ID</th>
                                <th>氏名</th>
                                <th>メール</th>
                                <th>部署</th>
                                <th>最終ログイン</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 学習進捗タブ -->
            <div id="progress" class="tab-content">
                <h2>学習進捗管理</h2>
                <div class="data-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ユーザー</th>
                                <th>部署</th>
                                <th>レッスン1</th>
                                <th>レッスン2</th>
                                <th>レッスン3</th>
                                <th>レッスン4</th>
                                <th>レッスン5</th>
                                <th>全体進捗</th>
                            </tr>
                        </thead>
                        <tbody id="progress-table">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 実演管理タブ -->
            <div id="demonstrations" class="tab-content">
                <h2>実演記録管理</h2>
                <div class="data-table">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ユーザー</th>
                                <th>レッスン</th>
                                <th>課題</th>
                                <th>提出日時</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="demonstrations-table">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 実演詳細モーダル -->
    <div id="demo-modal" class="modal">
        <div class="modal-content">
            <h3>実演記録詳細</h3>
            <div id="demo-detail">
                <!-- JavaScriptで生成 -->
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="approveDemonstration()">承認</button>
                <button class="btn btn-danger" onclick="rejectDemonstration()">却下</button>
                <button class="btn" onclick="closeModal()">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUser = null;
        let currentDemoId = null;

        // 認証チェック
        async function checkAuth() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/verify-token`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    if (userData.role !== 'admin') {
                        alert('管理者権限が必要です');
                        window.location.href = '/student-dashboard.html';
                        return false;
                    }
                    
                    currentUser = userData;
                    document.getElementById('admin-name').textContent = `管理者`;
                    return true;
                } else {
                    // 無効なトークン
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('認証エラー:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return false;
            }
        }

        // ログアウト
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // タブ切り替え
        function showTab(tabId) {
            // タブボタンの状態更新
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // タブコンテンツの表示切り替え
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // データ読み込み
            switch(tabId) {
                case 'overview':
                    loadOverview();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'progress':
                    loadProgress();
                    break;
                case 'demonstrations':
                    loadDemonstrations();
                    break;
            }
        }

        // 概要データ読み込み
        async function loadOverview() {
            try {
                const token = localStorage.getItem('token');
                const [usersRes, progressRes, demosRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/api/admin/progress`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/api/admin/demonstrations`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const users = await usersRes.json();
                const progress = await progressRes.json();
                const demonstrations = await demosRes.json();

                // 統計更新
                const studentUsers = users.filter(u => u.role !== 'admin');
                document.getElementById('total-users').textContent = studentUsers.length;
                
                // 学習中ユーザー: 少なくとも1つのレッスンを開始したユニークユーザー数
                const activeUserIds = new Set(progress.map(p => p.user_id));
                document.getElementById('active-learners').textContent = activeUserIds.size;
                
                // 全レッスン完了者: 5レッスン全てを完了したユニークユーザー数
                const userProgress = {};
                progress.forEach(p => {
                    if (!userProgress[p.user_id]) {
                        userProgress[p.user_id] = new Set();
                    }
                    if (p.status === 'completed') {
                        userProgress[p.user_id].add(p.lesson_id);
                    }
                });
                const completedUsers = Object.values(userProgress).filter(lessons => lessons.size === 5).length;
                document.getElementById('completed-courses').textContent = completedUsers;
                
                document.getElementById('pending-demos').textContent = demonstrations.filter(d => d.status === 'submitted').length;

                // 全体進捗チャート
                renderOverallProgress(progress, users);

            } catch (error) {
                console.error('概要データの読み込み失敗:', error);
            }
        }

        // 全体進捗チャート
        function renderOverallProgress(progress, users) {
            const lessonNames = ['レッスン1', 'レッスン2', 'レッスン3', 'レッスン4', 'レッスン5'];
            const container = document.getElementById('overall-progress');
            
            const lessonProgress = lessonNames.map((name, index) => {
                const lessonId = index + 1;
                const completed = progress.filter(p => p.lesson_id === lessonId && p.status === 'completed').length;
                const total = users.filter(u => u.role !== 'admin').length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                return `
                    <div class="lesson-progress">
                        <div class="lesson-title">${name} (${completed}/${total}人完了)</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = lessonProgress;
        }

        // ユーザー一覧読み込み
        async function loadUsers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const users = await response.json();
                const tableBody = document.getElementById('users-table');
                
                tableBody.innerHTML = users.filter(u => u.role !== 'admin').map(user => `
                    <tr>
                        <td>${user.employee_id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.department || '-'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString('ja-JP') : '未ログイン'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm">詳細</button>
                                <button class="btn btn-danger btn-sm">削除</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('ユーザーデータの読み込み失敗:', error);
            }
        }

        // ユーザー登録フォーム
        document.getElementById('add-user-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                employee_id: formData.get('employee_id'),
                name: formData.get('name'),
                email: formData.get('email'),
                department: formData.get('department'),
                password: formData.get('password')
            };

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('ユーザーが正常に登録されました');
                    e.target.reset();
                    loadUsers();
                } else {
                    alert(result.error || '登録に失敗しました');
                }
            } catch (error) {
                console.error('ユーザー登録エラー:', error);
                alert('登録に失敗しました');
            }
        });

        // 進捗一覧読み込み
        async function loadProgress() {
            try {
                const token = localStorage.getItem('token');
                const [progressRes, usersRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/progress`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const progress = await progressRes.json();
                const users = await usersRes.json();
                
                // ユーザーごとの進捗をまとめる
                const userProgress = {};
                users.filter(u => u.role !== 'admin').forEach(user => {
                    userProgress[user.id] = {
                        user: user,
                        lessons: {}
                    };
                });

                progress.forEach(p => {
                    if (userProgress[p.user_id]) {
                        userProgress[p.user_id].lessons[p.lesson_id] = p;
                    }
                });

                const tableBody = document.getElementById('progress-table');
                tableBody.innerHTML = Object.values(userProgress).map(up => {
                    const getStatusBadge = (lessonId) => {
                        const lesson = up.lessons[lessonId];
                        if (!lesson) return '<span class="status-badge status-not-started">未開始 0%</span>';
                        
                        let className = 'status-not-started';
                        let text = '未開始';
                        let progressText = '0%';
                        
                        // 動的スライド数を取得
                        const totalSlides = lessonSlideCounts[lessonId] || 10;
                        
                        if (lesson.status === 'in_progress') {
                            className = 'status-in-progress';
                            text = '学習中';
                            const percentage = Math.round((lesson.last_slide / totalSlides) * 100);
                            progressText = `${percentage}% (${lesson.last_slide}/${totalSlides})`;
                        } else if (lesson.status === 'completed') {
                            className = 'status-completed';
                            text = '完了';
                            progressText = `100% (${totalSlides}/${totalSlides})`;
                        }
                        
                        return `<span class="status-badge ${className}">${text} ${progressText}</span>`;
                    };
                    
                    const completedCount = Object.values(up.lessons).filter(l => l.status === 'completed').length;
                    const overallProgress = Math.round((completedCount / 5) * 100);
                    
                    return `
                        <tr>
                            <td>${up.user.name}<br><small>${up.user.employee_id}</small></td>
                            <td>${up.user.department || '-'}</td>
                            <td>${getStatusBadge(1)}</td>
                            <td>${getStatusBadge(2)}</td>
                            <td>${getStatusBadge(3)}</td>
                            <td>${getStatusBadge(4)}</td>
                            <td>${getStatusBadge(5)}</td>
                            <td><strong>${overallProgress}%</strong></td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('進捗データの読み込み失敗:', error);
            }
        }

        // 実演記録読み込み
        async function loadDemonstrations() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/admin/demonstrations`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const demonstrations = await response.json();
                const tableBody = document.getElementById('demonstrations-table');
                
                tableBody.innerHTML = demonstrations.map(demo => {
                    let statusClass = 'status-pending';
                    let statusText = '待機中';
                    
                    if (demo.status === 'submitted') {
                        statusClass = 'status-submitted';
                        statusText = '提出済み';
                    } else if (demo.status === 'approved') {
                        statusClass = 'status-approved';
                        statusText = '承認済み';
                    } else if (demo.status === 'rejected') {
                        statusClass = 'status-rejected';
                        statusText = '却下';
                    }
                    
                    return `
                        <tr>
                            <td>${demo.name}<br><small>${demo.employee_id}</small></td>
                            <td>レッスン${demo.lesson_id}</td>
                            <td>${demo.task_id}</td>
                            <td>${new Date(demo.submitted_at).toLocaleDateString('ja-JP')}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-info btn-sm" onclick="viewDemonstration(${demo.id})">詳細</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('実演データの読み込み失敗:', error);
            }
        }

        // 実演詳細表示
        function viewDemonstration(demoId) {
            // TODO: 実演詳細データを取得して表示
            currentDemoId = demoId;
            document.getElementById('demo-detail').innerHTML = `
                <div class="demo-evidence">
                    <p><strong>実演内容:</strong></p>
                    <p>サンプル実演内容がここに表示されます...</p>
                </div>
                <div class="form-group">
                    <label>フィードバック</label>
                    <textarea id="feedback-text" rows="4" placeholder="フィードバックを入力してください..."></textarea>
                </div>
            `;
            document.getElementById('demo-modal').style.display = 'block';
        }

        // 実演承認
        async function approveDemonstration() {
            await updateDemonstrationStatus('approved');
        }

        // 実演却下
        async function rejectDemonstration() {
            await updateDemonstrationStatus('rejected');
        }

        // 実演ステータス更新
        async function updateDemonstrationStatus(status) {
            const feedback = document.getElementById('feedback-text').value;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/admin/demonstration/${currentDemoId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        feedback: feedback
                    })
                });

                if (response.ok) {
                    alert(`実演記録を${status === 'approved' ? '承認' : '却下'}しました`);
                    closeModal();
                    loadDemonstrations();
                } else {
                    alert('更新に失敗しました');
                }
            } catch (error) {
                console.error('実演ステータス更新エラー:', error);
                alert('更新に失敗しました');
            }
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('demo-modal').style.display = 'none';
            currentDemoId = null;
        }

        // レッスンのスライド数データ
        const lessonSlideCounts = {};

        // スライド数を動的に取得
        async function loadSlideCounts() {
            try {
                for (let lessonId = 1; lessonId <= 5; lessonId++) {
                    const response = await fetch(`${API_BASE}/api/lesson/${lessonId}/slide-count`);
                    if (response.ok) {
                        const data = await response.json();
                        lessonSlideCounts[lessonId] = data.totalSlides;
                        console.log(`レッスン${lessonId}: ${lessonSlideCounts[lessonId]}スライド`);
                    } else {
                        // フォールバック
                        lessonSlideCounts[lessonId] = 10;
                        console.warn(`レッスン${lessonId}: スライド数取得失敗、デフォルト値(10)を使用`);
                    }
                }
            } catch (error) {
                console.error('スライド数取得エラー:', error);
                // エラー時はデフォルト値を設定
                for (let lessonId = 1; lessonId <= 5; lessonId++) {
                    lessonSlideCounts[lessonId] = 10;
                }
            }
        }

        // 初期化
        async function init() {
            if (!checkAuth()) return;
            
            // スライド数を最初に取得
            await loadSlideCounts();
            
            loadOverview();
        }

        // ページ読み込み時に初期化
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <footer class="footer">
        © 2025 AI研修法人. All rights reserved.
    </footer>
</body>
</html>